<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OHT-50 • Audit Trail</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&family=Merriweather:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./oht50_vintage_1.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.0.0/dist/flowbite.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body class="min-h-screen">
  <header class="w-full sticky top-0 z-40 border-b" style="border-color: var(--border)">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold" style="font-family: var(--font-serif)">Audit Trail</h1>
      <div class="flex items-center gap-2">
        <a class="btn btn-ghost" href="./oht50_overview_1.html"><i data-lucide="arrow-left"></i> <span class="ml-1">Tổng quan</span></a>
        <button id="btnDark" class="btn btn-ghost" type="button" title="Dark/Light"><i data-lucide="moon"></i></button>
      </div>
    </div>
  </header>

  <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <section class="card p-4">
      <div class="flex flex-wrap items-center gap-2">
        <input id="userQ" class="px-2 py-1 rounded border" style="border-color: var(--input)" placeholder="User"/>
        <select id="actionQ" class="px-2 py-1 rounded border" style="border-color: var(--input)">
          <option value="">All actions</option>
          <option>LOGIN</option>
          <option>START</option>
          <option>STOP</option>
          <option>E‑STOP</option>
          <option>APPLY_CONFIG</option>
        </select>
        <input id="timeQ" type="datetime-local" class="px-2 py-1 rounded border" style="border-color: var(--input)"/>
        <input id="sessionQ" class="px-2 py-1 rounded border" style="border-color: var(--input)" placeholder="Session ID"/>
        <input id="deviceQ" class="px-2 py-1 rounded border" style="border-color: var(--input)" placeholder="Device ID"/>
        <button id="btnFilter" class="btn btn-ghost" type="button"><i data-lucide="filter"></i> <span class="ml-1">Lọc</span></button>
        <div class="ml-auto flex items-center gap-2">
          <button id="expCsv" class="btn btn-ghost" type="button"><i data-lucide="file-down"></i> <span class="ml-1">Export CSV</span></button>
        </div>
      </div>
    </section>

    <section class="card p-4" aria-labelledby="auditTableTitle">
      <h2 id="auditTableTitle" class="sr-only">Bảng Audit Trail</h2>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th class="py-2 pr-4">Time</th>
              <th class="py-2 pr-4">User</th>
              <th class="py-2 pr-4">Action</th>
              <th class="py-2 pr-4">Target</th>
              <th class="py-2 pr-4">Result</th>
              <th class="py-2 pr-4">IP</th>
              <th class="py-2 pr-4">Session</th>
              <th class="py-2 pr-4">Device</th>
              <th class="py-2 pr-4">Correlation ID</th>
              <th class="py-2">Signature</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    window.lucide && window.lucide.createIcons();
    document.getElementById('btnDark').addEventListener('click', ()=>{
      const cur = document.body.getAttribute('data-theme');
      document.body.setAttribute('data-theme', cur==='dark'?'light':'dark');
    });
    const data = [
      {t:'10:01:00.001', u:'alice', a:'LOGIN', tgt:'—', r:'OK', ip:'10.0.0.2', sid:'S-1', dev:'OHT-50-01', corr:'c-1c8f', sig:'sha256:abcd…'},
      {t:'10:02:12.222', u:'alice', a:'START', tgt:'Move', r:'ACCEPTED', ip:'10.0.0.2', sid:'S-1', dev:'OHT-50-01', corr:'c-1c8f', sig:'sha256:bcde…'},
      {t:'10:03:45.010', u:'bob', a:'APPLY_CONFIG', tgt:'safety.limits', r:'OK', ip:'10.0.0.3', sid:'S-2', dev:'OHT-50-02', corr:'c-9aa2', sig:'sha256:ef12…'}
    ];
    let lastFiltered = data;
    function render(){
      const uq = document.getElementById('userQ').value.toLowerCase();
      const aq = document.getElementById('actionQ').value;
      const tq = document.getElementById('timeQ').value;
      const sq = document.getElementById('sessionQ').value.toLowerCase();
      const dq = document.getElementById('deviceQ').value.toLowerCase();
      const rows = document.getElementById('rows');
      rows.innerHTML = '';
      lastFiltered = data.filter(d=> (!uq || d.u.toLowerCase().includes(uq)) && (!aq || d.a===aq) && (!sq || d.sid.toLowerCase().includes(sq)) && (!dq || d.dev.toLowerCase().includes(dq)));
      lastFiltered.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class=\"py-2 pr-4\">${d.t}</td><td class=\"py-2 pr-4\">${d.u}</td><td class=\"py-2 pr-4\">${d.a}</td><td class=\"py-2 pr-4\">${d.tgt}</td><td class=\"py-2 pr-4\">${d.r}</td><td class=\"py-2 pr-4\">${d.ip}</td><td class=\"py-2 pr-4\">${d.sid}</td><td class=\"py-2 pr-4\">${d.dev}</td><td class=\"py-2 pr-4\">${d.corr}</td><td class=\"py-2\">${d.sig}</td>`;
        rows.appendChild(tr);
      });
    }
    function applyFiltersFromQuery(){
      const p = new URLSearchParams(location.search);
      if (p.has('user')) document.getElementById('userQ').value = p.get('user');
      if (p.has('action')) document.getElementById('actionQ').value = p.get('action');
      if (p.has('time')) document.getElementById('timeQ').value = p.get('time');
      if (p.has('session')) document.getElementById('sessionQ').value = p.get('session');
      if (p.has('device')) document.getElementById('deviceQ').value = p.get('device');
    }
    applyFiltersFromQuery();
    render();
    document.getElementById('btnFilter').addEventListener('click', ()=>{
      const qp = new URLSearchParams();
      const user = document.getElementById('userQ').value.trim(); if (user) qp.set('user', user);
      const action = document.getElementById('actionQ').value; if (action) qp.set('action', action);
      const time = document.getElementById('timeQ').value; if (time) qp.set('time', time);
      const session = document.getElementById('sessionQ').value.trim(); if (session) qp.set('session', session);
      const device = document.getElementById('deviceQ').value.trim(); if (device) qp.set('device', device);
      const qs = qp.toString();
      window.history.replaceState(null, '', qs ? ('?' + qs) : location.pathname);
      render();
    });

    // Export CSV
    function download(name, text){ const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); a.download=name; a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    document.getElementById('expCsv').addEventListener('click', ()=>{
      const header = ['time','user','action','target','result','ip','session','device','correlation_id','signature'];
      const rows = lastFiltered.map(d=> [d.t,d.u,d.a,d.tgt,d.r,d.ip,d.sid,d.dev,d.corr,d.sig].join(','));
      const csv = [header.join(',')].concat(rows).join('\n');
      download('audit.csv', csv);
    });
  </script>
</body>
</html>


